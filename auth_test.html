<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Auth test â€“ FastAPI</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    h2 { margin-top: 32px; }
    form, .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; max-width: 560px; }
    label { display:block; margin: 8px 0 4px; }
    input, select { width:100%; padding:8px; }
    button { margin-top:12px; padding:8px 12px; }
    pre { background:#f8f8f8; padding:12px; border-radius:6px; overflow:auto; }
    .row { display:flex; gap:24px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>Test autenticazione FastAPI</h1>

  <div class="row">
    <!-- REGISTRAZIONE (JSON) -->
    <form id="registerForm">
      <h2>Registrazione (POST /auth/register, JSON)</h2>
      <label>Username</label>
      <input id="regUsername" type="text" value="marcy" required />

      <label>Email</label>
      <input id="regEmail" type="email" value="marcy@example.com" required />

      <label>Password</label>
      <input id="regPassword" type="password" value="test123" required />

      <label>Nome</label>
      <input id="regName" type="text" value="Marcello" required />

      <label>Status</label>
      <select id="regStatus" required>
        <option value="attivo" selected>attivo</option>
        <option value="abbonato">abbonato</option>
        <option value="sospeso">sospeso</option>
        <option value="free">free</option>
      </select>

      <button type="submit">Registra</button>
      <pre id="registerResult"></pre>
    </form>

    <!-- LOGIN (x-www-form-urlencoded) -->
    <form id="loginForm" method="post" action="/auth/login">
      <h2>Login (POST /auth/login, form)</h2>
      <label>Username</label>
      <input name="username" type="text" value="marcy" required />

      <label>Password</label>
      <input name="password" type="password" value="test123" required />

      <button type="submit">Login</button>
      <pre id="loginResult"></pre>
    </form>
  </div>

  <!-- TEST /me -->
  <div class="card">
    <h2>Endpoint protetto (GET /auth/me)</h2>
    <label>Token</label>
    <input id="tokenInput" type="text" placeholder="Bearer token" />
    <button id="meBtn">Chiama /auth/me</button>
    <pre id="meResult"></pre>
  </div>

  <script>
    const baseUrl = "http://localhost:8000";

    // Registrazione via fetch JSON
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const body = {
        username: document.getElementById("regUsername").value.trim(),
        email: document.getElementById("regEmail").value.trim(),
        password: document.getElementById("regPassword").value,
        name: document.getElementById("regName").value.trim(),
        status: document.getElementById("regStatus").value
      };
      try {
        const res = await fetch(`${baseUrl}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const text = await res.text();
        document.getElementById("registerResult").textContent =
          `Status: ${res.status}\n${text}`;
      } catch (err) {
        document.getElementById("registerResult").textContent = String(err);
      }
    });

    // Intercettiamo il submit del form di login per mostrare il risultato a schermo
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new URLSearchParams(new FormData(form)).toString();
      try {
        const res = await fetch(`${baseUrl}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData
        });
        const json = await res.json();
        document.getElementById("loginResult").textContent =
          `Status: ${res.status}\n` + JSON.stringify(json, null, 2);
        if (json.access_token) {
          document.getElementById("tokenInput").value = json.access_token;
        }
      } catch (err) {
        document.getElementById("loginResult").textContent = String(err);
      }
    });

    // Test /me con Authorization: Bearer <token>
    document.getElementById("meBtn").addEventListener("click", async () => {
      const token = document.getElementById("tokenInput").value.trim();
      try {
        const res = await fetch(`${baseUrl}/auth/me`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` }
        });
        const text = await res.text();
        document.getElementById("meResult").textContent =
          `Status: ${res.status}\n${text}`;
      } catch (err) {
        document.getElementById("meResult").textContent = String(err);
      }
    });
  </script>
</body>
</html>